<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageImplRegistry.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">org.apache.xmlgraphics:xmlgraphics-commons</a> &gt; <a href="index.source.html" class="el_package">org.apache.xmlgraphics.image.loader.spi</a> &gt; <span class="el_source">ImageImplRegistry.java</span></div><h1>ImageImplRegistry.java</h1><pre class="source lang-java linenums">/* $$ This file has been instrumented by Clover 4.5.2#20240131180750 $$ *//*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* $Id: ImageImplRegistry.java 1904425 2022-10-06 12:37:37Z ssteiner $ */

package org.apache.xmlgraphics.image.loader.spi;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import org.apache.xmlgraphics.image.loader.ImageFlavor;
import org.apache.xmlgraphics.image.loader.ImageInfo;
import org.apache.xmlgraphics.image.loader.util.Penalty;
import org.apache.xmlgraphics.util.Service;

/**
 * This class is the registry for all implementations of the various service provider interfaces
 * for the image package.
 */
<span class="pc bpc" id="L44" title="3 of 4 branches missed.">public class ImageImplRegistry {public static class __CLR4_5_29ke9kem68iyhj1{public static com_atlassian_clover.CoverageRecorder R;public static com_atlassian_clover.CloverProfile[] profiles = { };@java.lang.SuppressWarnings(&quot;unchecked&quot;) public static &lt;I, T extends I&gt; I lambdaInc(final int i,final T l,final int si){java.lang.reflect.InvocationHandler h=new java.lang.reflect.InvocationHandler(){public java.lang.Object invoke(java.lang.Object p,java.lang.reflect.Method m,java.lang.Object[] a) throws Throwable{R.inc(i);R.inc(si);try{return m.invoke(l,a);}catch(java.lang.reflect.InvocationTargetException e){throw e.getCause()!=null?e.getCause():new RuntimeException(&quot;Clover failed to invoke instrumented lambda&quot;,e);}}};return (I)java.lang.reflect.Proxy.newProxyInstance(l.getClass().getClassLoader(),l.getClass().getInterfaces(),h);}public static &lt;T&gt; T caseInc(int i,java.util.function.Supplier&lt;T&gt; s){R.inc(i);return s.get();}public static void caseInc(int i,Runnable r){R.inc(i);r.run();}static{com_atlassian_clover.CoverageRecorder _R=null;try{com_atlassian_clover.CloverVersionInfo.An_old_version_of_clover_is_on_your_compilation_classpath___Please_remove___Required_version_is___4_5_2();if(20240131180750L!=com_atlassian_clover.CloverVersionInfo.getBuildStamp()){com_atlassian_clover.Clover.l(&quot;[CLOVER] WARNING: The Clover version used in instrumentation shall match the runtime version.&quot;);com_atlassian_clover.Clover.l(&quot;[CLOVER] WARNING: Instr=4.5.2#20240131180750,Runtime=&quot;+com_atlassian_clover.CloverVersionInfo.getReleaseNum()+&quot;#&quot;+com_atlassian_clover.CloverVersionInfo.getBuildStamp());}R=com_atlassian_clover.Clover.getNullRecorder();_R=com_atlassian_clover.Clover.getNullRecorder();_R=com_atlassian_clover.Clover.getRecorder(&quot;\u002f\u0063\u006f\u0064\u0065\u002f\u0063\u006f\u006e\u0063\u006f\u0072\u0064\u0069\u0061\u002f\u0053\u004f\u0045\u004e\u002d\u0033\u0034\u0035\u002d\u0054\u0075\u0074\u006f\u0072\u0069\u0061\u006c\u0073\u002f\u0074\u0075\u0074\u006f\u0072\u0069\u0061\u006c\u0031\u002f\u0050\u0061\u0072\u0074\u002d\u0042\u002f\u0078\u006d\u006c\u0067\u0072\u0061\u0070\u0068\u0069\u0063\u0073\u002d\u0063\u006f\u006d\u006d\u006f\u006e\u0073\u002d\u0032\u002e\u0038\u002f\u0074\u0061\u0072\u0067\u0065\u0074\u002f\u0063\u006c\u006f\u0076\u0065\u0072\u002f\u0063\u006c\u006f\u0076\u0065\u0072\u002e\u0064\u0062&quot;,1737587872955L,8589935092L,12612,profiles,new java.lang.String[]{&quot;clover.distributed.coverage&quot;,null});}catch(java.lang.SecurityException e){java.lang.System.err.println(&quot;[CLOVER] FATAL ERROR: Clover could not be initialised because it has insufficient security privileges. Please consult the Clover documentation on the security policy file changes required. (&quot;+e.getClass()+&quot;:&quot;+e.getMessage()+&quot;)&quot;);}catch(java.lang.NoClassDefFoundError e){java.lang.System.err.println(&quot;[CLOVER] FATAL ERROR: Clover could not be initialised. Are you sure you have Clover in the runtime classpath? (&quot;+e.getClass()+&quot;:&quot;+e.getMessage()+&quot;)&quot;);}catch(java.lang.Throwable t){java.lang.System.err.println(&quot;[CLOVER] FATAL ERROR: Clover could not be initialised because of an unexpected error. (&quot;+t.getClass()+&quot;:&quot;+t.getMessage()+&quot;)&quot;);}R=_R;}}public static final com_atlassian_clover.TestNameSniffer __CLR4_5_2_TEST_NAME_SNIFFER=com_atlassian_clover.TestNameSniffer.NULL_INSTANCE;</span>

    /** logger */
<span class="fc" id="L47">    protected static final Log log = LogFactory.getLog(ImageImplRegistry.class);</span>

    /** Infinite penalty value which shall force any implementation to become ineligible. */
    public static final int INFINITE_PENALTY = Integer.MAX_VALUE;

    /** Holds the list of preloaders */
<span class="fc" id="L53">    private List preloaders = new java.util.ArrayList();</span>
    //Content: List&lt;ImagePreloader&gt;
    private int lastPreloaderIdentifier;
    private int lastPreloaderSort;

    /** Holds the list of ImageLoaderFactories */
<span class="fc" id="L59">    private Map loaders = new java.util.HashMap();</span>
    //Content: Map&lt;String,Map&lt;ImageFlavor,ImageLoaderFactory&gt;&gt;

    /** Holds the list of ImageConverters */
<span class="fc" id="L63">    private List converters = new java.util.ArrayList();</span>
    //Content: List&lt;ImageConverter&gt;

    private int converterModifications;

    /** A Map (key: implementation classes) with additional penalties to fine-tune the registry. */
<span class="fc" id="L69">    private Map additionalPenalties = new java.util.HashMap(); //&lt;String, Penalty&gt;</span>
    //Note: String as key chosen to avoid possible class-unloading leaks

    /** Singleton instance */
<span class="fc" id="L73">    private static ImageImplRegistry defaultInstance = new ImageImplRegistry();</span>

    /**
     * Main constructor. This constructor allows to disable plug-in discovery for testing purposes.
     * @param discover true if implementation classes shall automatically be discovered.
     */
<span class="fc" id="L79">    public ImageImplRegistry(boolean discover) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12398);</span>
<span class="pc bpc" id="L80" title="4 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12399);if ((((discover)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12400)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12401)==0&amp;false))) {{</span>
<span class="fc" id="L81">            __CLR4_5_29ke9kem68iyhj1.R.inc(12402);discoverClasspathImplementations();</span>
        }
<span class="fc" id="L83">    }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Main constructor.
     */
    public ImageImplRegistry() {
<span class="fc" id="L89">        this(true);__CLR4_5_29ke9kem68iyhj1.R.inc(12404);try{__CLR4_5_29ke9kem68iyhj1.R.inc(12403);</span>
<span class="fc" id="L90">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Returns the default instance of the Image implementation registry.
     * @return the default instance
     */
<span class="fc" id="L96">    public static ImageImplRegistry getDefaultInstance() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12405);</span>
<span class="fc" id="L97">        __CLR4_5_29ke9kem68iyhj1.R.inc(12406);return defaultInstance;</span>
<span class="fc" id="L98">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Discovers all implementations in the application's classpath.
     */
<span class="fc" id="L103">    public void discoverClasspathImplementations() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12407);</span>
        //Dynamic registration of ImagePreloaders
<span class="fc" id="L105">        __CLR4_5_29ke9kem68iyhj1.R.inc(12408);Iterator iter = Service.providers(ImagePreloader.class);</span>
<span class="pc bpc" id="L106" title="4 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12409);while ((((iter.hasNext())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12410)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12411)==0&amp;false))) {{</span>
<span class="fc" id="L107">            __CLR4_5_29ke9kem68iyhj1.R.inc(12412);registerPreloader((ImagePreloader)iter.next());</span>
        }

        //Dynamic registration of ImageLoaderFactories
<span class="fc" id="L111">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12413);iter = Service.providers(ImageLoaderFactory.class);</span>
<span class="pc bpc" id="L112" title="4 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12414);while ((((iter.hasNext())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12415)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12416)==0&amp;false))) {{</span>
<span class="fc" id="L113">            __CLR4_5_29ke9kem68iyhj1.R.inc(12417);registerLoaderFactory((ImageLoaderFactory)iter.next());</span>
        }

        //Dynamic registration of ImageConverters
<span class="fc" id="L117">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12418);iter = Service.providers(ImageConverter.class);</span>
<span class="pc bpc" id="L118" title="4 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12419);while ((((iter.hasNext())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12420)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12421)==0&amp;false))) {{</span>
<span class="fc" id="L119">            __CLR4_5_29ke9kem68iyhj1.R.inc(12422);registerConverter((ImageConverter)iter.next());</span>
        }
<span class="fc" id="L121">    }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Registers a new ImagePreloader.
     * @param preloader An ImagePreloader instance
     */
<span class="fc" id="L127">    public void registerPreloader(ImagePreloader preloader) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12423);</span>
<span class="pc bpc" id="L128" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12424);if ((((log.isDebugEnabled())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12425)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12426)==0&amp;false))) {{</span>
<span class="nc" id="L129">            __CLR4_5_29ke9kem68iyhj1.R.inc(12427);log.debug(&quot;Registered &quot; + preloader.getClass().getName()</span>
<span class="nc" id="L130">                    + &quot; with priority &quot; + preloader.getPriority());</span>
        }
<span class="fc" id="L132">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12428);preloaders.add(newPreloaderHolder(preloader));</span>
<span class="fc" id="L133">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

<span class="fc" id="L135">    private synchronized PreloaderHolder newPreloaderHolder(ImagePreloader preloader) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12429);</span>
<span class="fc" id="L136">        __CLR4_5_29ke9kem68iyhj1.R.inc(12430);PreloaderHolder holder = new PreloaderHolder();</span>
<span class="fc" id="L137">        __CLR4_5_29ke9kem68iyhj1.R.inc(12431);holder.preloader = preloader;</span>
<span class="fc" id="L138">        __CLR4_5_29ke9kem68iyhj1.R.inc(12432);holder.identifier = ++lastPreloaderIdentifier;</span>
<span class="fc" id="L139">        __CLR4_5_29ke9kem68iyhj1.R.inc(12433);return holder;</span>
<span class="fc" id="L140">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /** Holder class for registered {@link ImagePreloader} instances. */
    private static class PreloaderHolder {
        private ImagePreloader preloader;
        private int identifier;

<span class="nc" id="L147">        public String toString() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12434);</span>
<span class="nc" id="L148">            __CLR4_5_29ke9kem68iyhj1.R.inc(12435);return preloader + &quot; &quot; + identifier;</span>
<span class="nc" id="L149">        }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>
    }

<span class="fc" id="L152">    private synchronized void sortPreloaders() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12436);</span>
<span class="pc bpc" id="L153" title="4 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12437);if ((((this.lastPreloaderIdentifier != this.lastPreloaderSort)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12438)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12439)==0&amp;false))) {{</span>
<span class="fc" id="L154">            __CLR4_5_29ke9kem68iyhj1.R.inc(12440);Collections.sort(this.preloaders, new Comparator() {</span>

<span class="fc" id="L156">                public int compare(Object o1, Object o2) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12441);</span>
<span class="fc" id="L157">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12442);PreloaderHolder h1 = (PreloaderHolder)o1;</span>
<span class="fc" id="L158">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12443);long p1 = h1.preloader.getPriority();</span>
<span class="fc" id="L159">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12444);p1 += getAdditionalPenalty(h1.preloader.getClass().getName()).getValue();</span>

<span class="fc" id="L161">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12445);PreloaderHolder h2 = (PreloaderHolder)o2;</span>
<span class="fc" id="L162">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12446);int p2 = h2.preloader.getPriority();</span>
<span class="fc" id="L163">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12447);p2 += getAdditionalPenalty(h2.preloader.getClass().getName()).getValue();</span>

<span class="fc" id="L165">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12448);int diff = Penalty.truncate(p1 - p2);</span>
<span class="pc bpc" id="L166" title="4 of 10 branches missed.">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12449);if ((((diff != 0)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12450)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12451)==0&amp;false))) {{</span>
<span class="fc" id="L167">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12452);return diff;</span>
                    } }else {{
<span class="fc" id="L169">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12453);diff = h1.identifier - h2.identifier;</span>
<span class="fc" id="L170">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12454);return diff;</span>
                    }
<span class="fc" id="L172">                }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

            });
<span class="fc" id="L175">            __CLR4_5_29ke9kem68iyhj1.R.inc(12455);this.lastPreloaderSort = lastPreloaderIdentifier;</span>
        }
<span class="fc" id="L177">    }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Registers a new ImageLoaderFactory.
     * @param loaderFactory An ImageLoaderFactory instance
     */
<span class="fc" id="L183">    public void registerLoaderFactory(ImageLoaderFactory loaderFactory) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12456);</span>
<span class="pc bpc" id="L184" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12457);if ((((!loaderFactory.isAvailable())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12458)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12459)==0&amp;false))) {{</span>
<span class="nc bnc" id="L185" title="All 10 branches missed.">            __CLR4_5_29ke9kem68iyhj1.R.inc(12460);if ((((log.isDebugEnabled())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12461)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12462)==0&amp;false))) {{</span>
<span class="nc" id="L186">                __CLR4_5_29ke9kem68iyhj1.R.inc(12463);log.debug(&quot;ImageLoaderFactory reports not available: &quot;</span>
<span class="nc" id="L187">                        + loaderFactory.getClass().getName());</span>
            }
<span class="nc" id="L189">            }__CLR4_5_29ke9kem68iyhj1.R.inc(12464);return;</span>
        }
<span class="fc" id="L191">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12465);String[] mimes = loaderFactory.getSupportedMIMETypes();</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12466);for (String mime : mimes) {{</span>
<span class="fc" id="L193">            __CLR4_5_29ke9kem68iyhj1.R.inc(12467);synchronized (loaders) {</span>
<span class="fc" id="L194">                __CLR4_5_29ke9kem68iyhj1.R.inc(12468);Map flavorMap = (Map) loaders.get(mime);</span>
<span class="pc bpc" id="L195" title="4 of 10 branches missed.">                __CLR4_5_29ke9kem68iyhj1.R.inc(12469);if ((((flavorMap == null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12470)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12471)==0&amp;false))) {{</span>
<span class="fc" id="L196">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12472);flavorMap = new HashMap();</span>
<span class="fc" id="L197">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12473);loaders.put(mime, flavorMap);</span>
                }

<span class="fc" id="L200">                }__CLR4_5_29ke9kem68iyhj1.R.inc(12474);ImageFlavor[] flavors = loaderFactory.getSupportedFlavors(mime);</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">                __CLR4_5_29ke9kem68iyhj1.R.inc(12475);for (ImageFlavor flavor : flavors) {{</span>
<span class="fc" id="L202">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12476);List factoryList = (List) flavorMap.get(flavor);</span>
<span class="pc bpc" id="L203" title="4 of 10 branches missed.">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12477);if ((((factoryList == null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12478)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12479)==0&amp;false))) {{</span>
<span class="fc" id="L204">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12480);factoryList = new ArrayList();</span>
<span class="fc" id="L205">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12481);flavorMap.put(flavor, factoryList);</span>
                    }
<span class="fc" id="L207">                    }__CLR4_5_29ke9kem68iyhj1.R.inc(12482);factoryList.add(loaderFactory);</span>

<span class="pc bpc" id="L209" title="7 of 10 branches missed.">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12483);if ((((log.isDebugEnabled())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12484)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12485)==0&amp;false))) {{</span>
<span class="nc" id="L210">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12486);log.debug(&quot;Registered &quot; + loaderFactory.getClass().getName()</span>
                                + &quot;: MIME = &quot; + mime + &quot;, Flavor = &quot; + flavor);
                    }
                }}
<span class="fc" id="L214">            }}</span>
        }
<span class="fc" id="L216">    }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Returns the Collection of registered ImageConverter instances.
     * @return a Collection&amp;lt;ImageConverter&amp;gt;
     */
<span class="fc" id="L222">    public Collection getImageConverters() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12487);</span>
<span class="fc" id="L223">        __CLR4_5_29ke9kem68iyhj1.R.inc(12488);return Collections.unmodifiableList(this.converters);</span>
<span class="fc" id="L224">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Returns the number of modifications to the collection of registered ImageConverter instances.
     * This is used to detect changes in the registry concerning ImageConverters.
     * @return the number of modifications
     */
<span class="fc" id="L231">    public int getImageConverterModifications() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12489);</span>
<span class="fc" id="L232">        __CLR4_5_29ke9kem68iyhj1.R.inc(12490);return this.converterModifications;</span>
<span class="fc" id="L233">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Registers a new ImageConverter.
     * @param converter An ImageConverter instance
     */
<span class="fc" id="L239">    public void registerConverter(ImageConverter converter) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12491);</span>
<span class="fc" id="L240">        __CLR4_5_29ke9kem68iyhj1.R.inc(12492);converters.add(converter);</span>
<span class="fc" id="L241">        __CLR4_5_29ke9kem68iyhj1.R.inc(12493);converterModifications++;</span>
<span class="pc bpc" id="L242" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12494);if ((((log.isDebugEnabled())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12495)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12496)==0&amp;false))) {{</span>
<span class="nc" id="L243">            __CLR4_5_29ke9kem68iyhj1.R.inc(12497);log.debug(&quot;Registered: &quot; + converter.getClass().getName());</span>
        }
<span class="fc" id="L245">    }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Returns an iterator over all registered ImagePreloader instances.
     * @return an iterator over ImagePreloader instances.
     */
<span class="fc" id="L251">    public Iterator getPreloaderIterator() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12498);</span>
<span class="fc" id="L252">        __CLR4_5_29ke9kem68iyhj1.R.inc(12499);sortPreloaders();</span>
<span class="fc" id="L253">        __CLR4_5_29ke9kem68iyhj1.R.inc(12500);final Iterator iter = this.preloaders.iterator();</span>
        //Unpack the holders
<span class="fc" id="L255">        __CLR4_5_29ke9kem68iyhj1.R.inc(12501);MyIterator i = new MyIterator();</span>
<span class="fc" id="L256">        __CLR4_5_29ke9kem68iyhj1.R.inc(12502);i.iter = iter;</span>
<span class="fc" id="L257">        __CLR4_5_29ke9kem68iyhj1.R.inc(12503);return i;</span>
<span class="fc" id="L258">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

<span class="fc" id="L260">    static class MyIterator implements Iterator {</span>
        Iterator iter;
<span class="fc" id="L262">        public boolean hasNext() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12504);</span>
<span class="fc" id="L263">            __CLR4_5_29ke9kem68iyhj1.R.inc(12505);return iter.hasNext();</span>
<span class="fc" id="L264">        }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

<span class="fc" id="L266">        public Object next() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12506);</span>
<span class="fc" id="L267">            __CLR4_5_29ke9kem68iyhj1.R.inc(12507);Object obj = iter.next();</span>
<span class="pc bpc" id="L268" title="7 of 10 branches missed.">            __CLR4_5_29ke9kem68iyhj1.R.inc(12508);if ((((obj != null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12509)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12510)==0&amp;false))) {{</span>
<span class="fc" id="L269">                __CLR4_5_29ke9kem68iyhj1.R.inc(12511);return ((PreloaderHolder)obj).preloader;</span>
            } }else {{
<span class="nc" id="L271">                __CLR4_5_29ke9kem68iyhj1.R.inc(12512);return null;</span>
            }
<span class="fc" id="L273">        }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

<span class="nc" id="L275">        public void remove() {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12513);</span>
<span class="nc" id="L276">            __CLR4_5_29ke9kem68iyhj1.R.inc(12514);iter.remove();</span>
<span class="nc" id="L277">        }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    }

    /**
     * Returns the best ImageLoaderFactory supporting the {@link ImageInfo} and image flavor.
     * If there are multiple ImageLoaderFactories the one with the least usage penalty is selected.
     * @param imageInfo the image info object
     * @param flavor the image flavor.
     * @return an ImageLoaderFactory instance or null, if no suitable implementation was found
     */
<span class="fc" id="L288">    public ImageLoaderFactory getImageLoaderFactory(ImageInfo imageInfo, ImageFlavor flavor) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12515);</span>
<span class="fc" id="L289">        __CLR4_5_29ke9kem68iyhj1.R.inc(12516);String mime = imageInfo.getMimeType();</span>
<span class="fc" id="L290">        __CLR4_5_29ke9kem68iyhj1.R.inc(12517);Map flavorMap = (Map)loaders.get(mime);</span>
<span class="pc bpc" id="L291" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12518);if ((((flavorMap != null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12519)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12520)==0&amp;false))) {{</span>
<span class="fc" id="L292">            __CLR4_5_29ke9kem68iyhj1.R.inc(12521);List factoryList = (List)flavorMap.get(flavor);</span>
<span class="pc bpc" id="L293" title="8 of 12 branches missed.">            __CLR4_5_29ke9kem68iyhj1.R.inc(12522);if ((((factoryList != null &amp;&amp; factoryList.size() &gt; 0)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12523)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12524)==0&amp;false))) {{</span>
<span class="fc" id="L294">                __CLR4_5_29ke9kem68iyhj1.R.inc(12525);Iterator iter = factoryList.iterator();</span>
<span class="fc" id="L295">                __CLR4_5_29ke9kem68iyhj1.R.inc(12526);int bestPenalty = Integer.MAX_VALUE;</span>
<span class="fc" id="L296">                __CLR4_5_29ke9kem68iyhj1.R.inc(12527);ImageLoaderFactory bestFactory = null;</span>
<span class="pc bpc" id="L297" title="4 of 10 branches missed.">                __CLR4_5_29ke9kem68iyhj1.R.inc(12528);while ((((iter.hasNext())&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12529)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12530)==0&amp;false))) {{</span>
<span class="fc" id="L298">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12531);ImageLoaderFactory factory = (ImageLoaderFactory)iter.next();</span>
<span class="pc bpc" id="L299" title="7 of 10 branches missed.">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12532);if ((((!factory.isSupported(imageInfo))&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12533)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12534)==0&amp;false))) {{</span>
<span class="nc" id="L300">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12535);continue;</span>
                    }
<span class="fc" id="L302">                    }__CLR4_5_29ke9kem68iyhj1.R.inc(12536);ImageLoader loader = factory.newImageLoader(flavor);</span>
<span class="fc" id="L303">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12537);int penalty = loader.getUsagePenalty();</span>
<span class="pc bpc" id="L304" title="7 of 10 branches missed.">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12538);if ((((penalty &lt; bestPenalty)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12539)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12540)==0&amp;false))) {{</span>
<span class="fc" id="L305">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12541);bestPenalty = penalty;</span>
<span class="fc" id="L306">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12542);bestFactory = factory;</span>
                    }
<span class="fc" id="L308">                }}</span>
<span class="fc" id="L309">                }__CLR4_5_29ke9kem68iyhj1.R.inc(12543);return bestFactory;</span>
            }
        }}
<span class="nc" id="L312">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12544);return null;</span>
<span class="fc" id="L313">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Returns an array of {@link ImageLoaderFactory} instances that support the MIME type
     * indicated by an {@link ImageInfo} object and can generate the given image flavor.
     * @param imageInfo the image info object
     * @param flavor the target image flavor
     * @return the array of image loader factories
     */
<span class="fc" id="L322">    public ImageLoaderFactory[] getImageLoaderFactories(ImageInfo imageInfo, ImageFlavor flavor) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12545);</span>
<span class="fc" id="L323">        __CLR4_5_29ke9kem68iyhj1.R.inc(12546);String mime = imageInfo.getMimeType();</span>
<span class="fc" id="L324">        __CLR4_5_29ke9kem68iyhj1.R.inc(12547);Collection matches = new java.util.TreeSet(new ImageLoaderFactoryComparator(flavor));</span>
<span class="fc" id="L325">        __CLR4_5_29ke9kem68iyhj1.R.inc(12548);imageInfo.getCustomObjects().put(&quot;additionalPenalties&quot;, additionalPenalties);</span>
<span class="fc" id="L326">        __CLR4_5_29ke9kem68iyhj1.R.inc(12549);Map flavorMap = (Map) loaders.get(mime);</span>
<span class="pc bpc" id="L327" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12550);if ((((flavorMap != null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12551)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12552)==0&amp;false))) {{</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">            __CLR4_5_29ke9kem68iyhj1.R.inc(12553);for (Object i : flavorMap.entrySet()) {{</span>
<span class="fc" id="L329">                __CLR4_5_29ke9kem68iyhj1.R.inc(12554);Map.Entry e = (Map.Entry) i;</span>
<span class="fc" id="L330">                __CLR4_5_29ke9kem68iyhj1.R.inc(12555);ImageFlavor checkFlavor = (ImageFlavor) e.getKey();</span>
<span class="pc bpc" id="L331" title="4 of 10 branches missed.">                __CLR4_5_29ke9kem68iyhj1.R.inc(12556);if ((((checkFlavor.isCompatible(flavor))&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12557)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12558)==0&amp;false))) {{</span>
<span class="fc" id="L332">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12559);List factoryList = (List)e.getValue();</span>
<span class="pc bpc" id="L333" title="8 of 12 branches missed.">                    __CLR4_5_29ke9kem68iyhj1.R.inc(12560);if ((((factoryList != null &amp;&amp; factoryList.size() &gt; 0)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12561)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12562)==0&amp;false))) {{</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">                        __CLR4_5_29ke9kem68iyhj1.R.inc(12563);for (Object aFactoryList : factoryList) {{</span>
<span class="fc" id="L335">                            __CLR4_5_29ke9kem68iyhj1.R.inc(12564);ImageLoaderFactory factory = (ImageLoaderFactory) aFactoryList;</span>
<span class="pc bpc" id="L336" title="4 of 10 branches missed.">                            __CLR4_5_29ke9kem68iyhj1.R.inc(12565);if ((((factory.isSupported(imageInfo))&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12566)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12567)==0&amp;false))) {{</span>
<span class="fc" id="L337">                                __CLR4_5_29ke9kem68iyhj1.R.inc(12568);matches.add(factory);</span>
                            }
                        }}
<span class="fc" id="L340">                    }}</span>
                }}
            }}
<span class="fc" id="L343">        }}</span>
<span class="pc bpc" id="L344" title="4 of 10 branches missed.">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12569);if ((((matches.size() == 0)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12570)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12571)==0&amp;false))) {{</span>
<span class="fc" id="L345">            __CLR4_5_29ke9kem68iyhj1.R.inc(12572);return null;</span>
        } }else {{
<span class="fc" id="L347">            __CLR4_5_29ke9kem68iyhj1.R.inc(12573);return (ImageLoaderFactory[])matches.toArray(new ImageLoaderFactory[matches.size()]);</span>
        }
<span class="fc" id="L349">    }}finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /** Comparator for {@link ImageLoaderFactory} classes. */
    private class ImageLoaderFactoryComparator implements Comparator {

        private ImageFlavor targetFlavor;

<span class="fc" id="L356">        public ImageLoaderFactoryComparator(ImageFlavor targetFlavor) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12574);</span>
<span class="fc" id="L357">            __CLR4_5_29ke9kem68iyhj1.R.inc(12575);this.targetFlavor = targetFlavor;</span>
<span class="fc" id="L358">        }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

<span class="fc" id="L360">        public int compare(Object o1, Object o2) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12576);</span>
<span class="fc" id="L361">            __CLR4_5_29ke9kem68iyhj1.R.inc(12577);ImageLoaderFactory f1 = (ImageLoaderFactory)o1;</span>
<span class="fc" id="L362">            __CLR4_5_29ke9kem68iyhj1.R.inc(12578);ImageLoader l1 = f1.newImageLoader(targetFlavor);</span>
<span class="fc" id="L363">            __CLR4_5_29ke9kem68iyhj1.R.inc(12579);long p1 = l1.getUsagePenalty();</span>
<span class="fc" id="L364">            __CLR4_5_29ke9kem68iyhj1.R.inc(12580);p1 += getAdditionalPenalty(l1.getClass().getName()).getValue();</span>

<span class="fc" id="L366">            __CLR4_5_29ke9kem68iyhj1.R.inc(12581);ImageLoaderFactory f2 = (ImageLoaderFactory)o2;</span>
<span class="fc" id="L367">            __CLR4_5_29ke9kem68iyhj1.R.inc(12582);ImageLoader l2 = f2.newImageLoader(targetFlavor);</span>
//            long p2 = l2.getUsagePenalty();
<span class="fc" id="L369">            __CLR4_5_29ke9kem68iyhj1.R.inc(12583);long p2 = getAdditionalPenalty(l2.getClass().getName()).getValue();</span>

            //Lowest penalty first
<span class="fc" id="L372">            __CLR4_5_29ke9kem68iyhj1.R.inc(12584);return Penalty.truncate(p1 - p2);</span>
<span class="fc" id="L373">        }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    }


    /**
     * Returns an array of ImageLoaderFactory instances which support the given MIME type. The
     * instances are returned in no particular order.
     * @param mime the MIME type to find ImageLoaderFactories for
     * @return the array of ImageLoaderFactory instances
     */
<span class="fc" id="L384">    public ImageLoaderFactory[] getImageLoaderFactories(String mime) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12585);</span>
<span class="fc" id="L385">        __CLR4_5_29ke9kem68iyhj1.R.inc(12586);Map flavorMap = (Map)loaders.get(mime);</span>
<span class="pc bpc" id="L386" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12587);if ((((flavorMap != null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12588)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12589)==0&amp;false))) {{</span>
<span class="fc" id="L387">            __CLR4_5_29ke9kem68iyhj1.R.inc(12590);Set factories = new java.util.HashSet();</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">            __CLR4_5_29ke9kem68iyhj1.R.inc(12591);for (Object o : flavorMap.values()) {{</span>
<span class="fc" id="L389">                __CLR4_5_29ke9kem68iyhj1.R.inc(12592);List factoryList = (List) o;</span>
<span class="fc" id="L390">                __CLR4_5_29ke9kem68iyhj1.R.inc(12593);factories.addAll(factoryList);</span>
            }
<span class="fc" id="L392">            }__CLR4_5_29ke9kem68iyhj1.R.inc(12594);int factoryCount = factories.size();</span>
<span class="pc bpc" id="L393" title="7 of 10 branches missed.">            __CLR4_5_29ke9kem68iyhj1.R.inc(12595);if ((((factoryCount &gt; 0)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12596)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12597)==0&amp;false))) {{</span>
<span class="fc" id="L394">                __CLR4_5_29ke9kem68iyhj1.R.inc(12598);return (ImageLoaderFactory[])factories.toArray(</span>
                        new ImageLoaderFactory[factoryCount]);
            }
        }}
<span class="nc" id="L398">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12599);return new ImageLoaderFactory[0];</span>
<span class="fc" id="L399">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Sets an additional penalty for a particular implementation class for any of the interface
     * administered by this registry class. No checking is performed to verify if the className
     * parameter is valid.
     * @param className the fully qualified class name of the implementation class
     * @param penalty the additional penalty or null to clear any existing value
     */
<span class="fc" id="L408">    public void setAdditionalPenalty(String className, Penalty penalty) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12600);</span>
<span class="pc bpc" id="L409" title="7 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12601);if ((((penalty != null)&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12602)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12603)==0&amp;false))) {{</span>
<span class="fc" id="L410">            __CLR4_5_29ke9kem68iyhj1.R.inc(12604);this.additionalPenalties.put(className, penalty);</span>
        } }else {{
<span class="nc" id="L412">            __CLR4_5_29ke9kem68iyhj1.R.inc(12605);this.additionalPenalties.remove(className);</span>
        }
<span class="fc" id="L414">        }__CLR4_5_29ke9kem68iyhj1.R.inc(12606);this.lastPreloaderSort = -1; //Force resort, just in case this was a preloader</span>
<span class="fc" id="L415">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

    /**
     * Returns the additional penalty value set for a particular implementation class.
     * If no such value is set, 0 is returned.
     * @param className the fully qualified class name of the implementation class
     * @return the additional penalty value
     */
<span class="fc" id="L423">    public Penalty getAdditionalPenalty(String className) {try{__CLR4_5_29ke9kem68iyhj1.R.inc(12607);</span>
<span class="fc" id="L424">        __CLR4_5_29ke9kem68iyhj1.R.inc(12608);Penalty p = (Penalty)this.additionalPenalties.get(className);</span>
<span class="pc bpc" id="L425" title="4 of 10 branches missed.">        __CLR4_5_29ke9kem68iyhj1.R.inc(12609);return ((((p != null )&amp;&amp;(__CLR4_5_29ke9kem68iyhj1.R.iget(12610)!=0|true))||(__CLR4_5_29ke9kem68iyhj1.R.iget(12611)==0&amp;false))? p : Penalty.ZERO_PENALTY);</span>
<span class="fc" id="L426">    }finally{__CLR4_5_29ke9kem68iyhj1.R.flushNeeded();}}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>